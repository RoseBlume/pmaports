# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=unity8
pkgver=0_git20201130
_commit="39876885449df890f936edcb5b7bc6a63e80f0a0"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://github.com/ubports/unity8"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects qt5-qtbase-sqlite settings-components gsettings-ubuntu-touch-schemas qtmir suru-icon-theme gsettings-desktop-schemas unity-system-compositor"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev ubuntu-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev ubuntu-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz system-settings lomiri-deviceinfo-dev"
checkdepends="py3-dbusmock"
source="$pkgname-$_commit.tar.gz::https://github.com/ubports/unity8/archive/$_commit.tar.gz
	0001-NoDpkgParse.patch
	0002-UAL3.patch
	0003-Add-missing-includes.patch
	0004-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0005-Link-against-libintl.patch
	"
subpackages="$pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/unity8/qml/mocks/QMenuModel/
}

sha512sums="5411f37375e52c63c6b7259cd3101e4ae020d17c84088c8168d3b36067fdd1eb45dbaf82e4908a1c42ba2c2fefb782acfe0a99ac3f140c7283b5be238f387db4  unity8-39876885449df890f936edcb5b7bc6a63e80f0a0.tar.gz
29a1b21f000eeae61b2281b3da6a0a1c6f8ac9cfb16dd72cfd4217ae69b83c71f0f418b11b45edc8fbf829e67a764687c9b0dae256abfd6eed9ed0b68af7248c  0001-NoDpkgParse.patch
01fd6536ad8efb9a5ee8db489cdc84fe406bbeadfaccd82a32dc063272a83f119618477e3e8365356c101e3f02eb304abae063dce9b0788280297f950638afdc  0002-UAL3.patch
2b04226993fd0a0540f33b49bf39b57dc2acf6869d47da74e01a675e9aa9e41ec598a52873a1b3f898d442f7c0b13c79abb7405677bc63cc387ceaa8129a67cf  0003-Add-missing-includes.patch
fa1e937a464ccc1bea1a2f29599cb325f3ea76d0848aeb7816142af3f350c8ac0bea8a534b0e13bfb02875849004fa3e71f8c331504976c060177e6dec071b0f  0004-Add-qt5-suffix-to-search-for-Qt-tools.patch
9773246b5d946c7dc62ebb75d88016c70348fce2ceb0991436863e810ab5eab96d4405253cef3897fd1bc211ecf81824d3c938ed85fb74b2cc6911012ff8a109  0005-Link-against-libintl.patch"
