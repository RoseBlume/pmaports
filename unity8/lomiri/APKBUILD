# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0_git20210414
_commit="2bf97a56bc40cc3da5bfd212cb4c3a54bfaa2961"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://gitlab.com/ubports/core/lomiri"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects qt5-qtbase-sqlite lomiri-settings-components gsettings-ubuntu-touch-schemas qtmir suru-icon-theme gsettings-desktop-schemas lomiri-system-compositor"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev lomiri-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev lomiri-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz lomiri-system-settings lomiri-deviceinfo-dev"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/core/lomiri/-/archive/$_commit/lomiri-$_commit.tar.gz
	0001-NoDpkgParse.patch
	0002-Add-missing-includes.patch
	0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0004-Link-against-libintl.patch
	0005-We-do-not-have-Android-stuff.patch
	0006-Fix-up-gschema.patch
	"
subpackages="$pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel/
}

sha512sums="cf520d797d8a532c60c89b99974403897d35e7290bec9a20a046031cf15165905d9cd384c5e9f58242bba52f679dedf752a1416938ff5f6a1f223242aefdd8fe  lomiri-2bf97a56bc40cc3da5bfd212cb4c3a54bfaa2961.tar.gz
a996fd2b69b0fc7ee344c3d4443cb1797727527335a816bffff0c68c71812f4a5ab457d0a6bb9541ae174c1a6732d6f8b986ed622b230504c77c861c2a80009e  0001-NoDpkgParse.patch
4fd730f3200930504b96576a84ed40e7461e5991b45fa00597e9783bbb4ff45749204ccd6a3a4b08590f4f0a9c3a14debe723919fee497499bea2274d8e70ff9  0002-Add-missing-includes.patch
518455a10e0c922215140e1c5af5e2e2192732a93a1e1f2c40b77db2f13da22ebf1d1eaf93abaa50f06f2645a392c85f17733fbf55ca2fc1a046498ddd16b0df  0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
7ac0d7dd13ea2bf72c1ab66599d57a8cedb0890a1585d995c60d62ed495bb69f875963b069590915891af4e6b151209b55bbb2f572e4b5b34561df4ce7a86e88  0004-Link-against-libintl.patch
9baa657a674beecffc01e766d185285bb397f6b0228ce87c85c1785e9625219069ab08a4c081d93cb6338eb6d0c727728393c545446b42b9085e2d08c7e30c53  0005-We-do-not-have-Android-stuff.patch
d57d1ab6fa52105a1250da4ca20ff80519e95b1b8eeb1c9a80690d74adc8e9ee7fcb7636231bec687dfb03b684b9bcc4074d95d997c2f45562c17e10e90e31ea  0006-Fix-up-gschema.patch"
