# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0_git20211216
_commit="405c3a6ebc802e30536595b63184c0781312207c"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://gitlab.com/ubports/core/lomiri"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects qt5-qtbase-sqlite lomiri-settings-components gsettings-ubuntu-touch-schemas suru-icon-theme gsettings-desktop-schemas lomiri-system-compositor lomiri-keyboard"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev lomiri-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev lomiri-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz lomiri-system-settings lomiri-deviceinfo-dev elogind-dev qtmir-dev"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/core/lomiri/-/archive/$_commit/lomiri-$_commit.tar.gz
	0001-Replace-own-lights-plugin-with-hfd-leds.patch
	0002-Replace-own-config-parser-with-libdeviceinfo.patch
	0003-NoDpkgParse.patch
	0004-Add-missing-includes.patch
	0005-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0006-Link-against-libintl.patch
	0007-No-systemd.patch
	0008-fixups.patch
	"
subpackages="$pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"
options="!check" # Tests fail

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel/
}

sha512sums="
031a54d6251d234b53126939b14e6643e692755bc8a49c298a6a2c8988b060119a88615dcdf8ad25a6d6a8b1f5c751ae90bbd9c5301e0c8faf2920028fbff889  lomiri-405c3a6ebc802e30536595b63184c0781312207c.tar.gz
dab1152ced9f881704f05ee47709e7bfaa22634d054e27bc820cafbdc3736ac2897fd07a8b2e736977a68f55c4cc211b0d72a7a1e1835a4db314a75b2e7133ab  0001-Replace-own-lights-plugin-with-hfd-leds.patch
676f20bd34389820932332f94c296756d632c2c36dea543f59ef7eba308461cd0d81ca9a725081c3e4a66e12bb67387db40716955aca64e2dd242f84bc9c785d  0002-Replace-own-config-parser-with-libdeviceinfo.patch
bc985880f564cccb3c00a2d492b336fa3486ca1fcf4846fd8cbd47db3d0785e83e091bb67040e7131b3ef100e5f4cdbef86471cc76f98ea5e0d0030962f22ee6  0003-NoDpkgParse.patch
a09ceeab5f3293877b0aed95c6547263e05c514affc73f29a4e951d23b815359ebbde37570416b03fecd32b08af6631d0903adc320181affbc49c2a5175424b0  0004-Add-missing-includes.patch
abbf4d5347968b55f373cce457d6a7b50f8af1107ad2481262f4bdbf0e0b9ad873a7322cbedef58ce2126dd7750ce05f48cc1cd64ba23f6197dfac3a26fe4414  0005-Add-qt5-suffix-to-search-for-Qt-tools.patch
f8154d545da5aed2cbb62c8bca68a64bd60c39eb6fa5aa735167fc058f350076e092c3708f6d2b26f144a3abae9be82a935d9c43cb0f164bb87591067e897286  0006-Link-against-libintl.patch
20e3b18ceda6366447b42fa5e0eb8d94f01d6dbb41d229a636825589a6267cbbd9f63eee4236e5b98ae79d6a4ce367e235b8d20b87b137a2149b70fc78fad146  0007-No-systemd.patch
9a5652d92921508754a53ee8e756d4e5fec6fb1c6658c9d577adbeef956fa37b0d9d710cab336f0f0947705428090a83ffd642997a8a6554efdb6c458a7a3fba  0008-fixups.patch
"
