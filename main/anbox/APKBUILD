# Contributor: Bart Ribbers <bribbers@disroot.org>
# Contributor: Grant Miller <GrantM11235@gmail.com>
# Maintainer:
pkgname=anbox
pkgver=0_git20190626
pkgrel=0
_commit="33b0654b34e897923c682b9bbfa6c1ca280064a2"
pkgdesc="Android in a box"
url="https://github.com/anbox/anbox"
arch="all"
license="GPL-3.0-or-later"
# FIXME: most of these depends should be detected automatically
# by abuild (it detects libraries linked against as depends)
depends="
	anbox-image
	dbus-libs
	glib
	mesa-gles
	mesa-egl
	"
makedepends="
	cmake
	boost-dev
	dbus-dev
	glib-dev
	libcap-dev
	mesa-dev
	protobuf-dev
	protobuf-c-dev
	sdl2-dev
	sdl2_image-dev
	elogind-dev
	properties-cpp-dev
	libexecinfo-dev
	glm-dev
	lxc-dev
	libdwarf-dev
	"
install="$pkgname.post-install $pkgname.post-deinstall"
source="
	$pkgname-$_commit.tar.gz::https://github.com/anbox/anbox/archive/$_commit.tar.gz
	99-anbox.rules
	anbox-container-manager.initd
	anbox.confd
	boost_io_context.patch
	disable-tests.patch
	musl-fixes.patch
	anbox-launch.sh
	anbox.desktop
	modules.conf
	"
builddir="$srcdir/$pkgname-$_commit"

prepare() {
	default_prepare

	mkdir -p "$builddir"/build

	# Remove -Werror
	sed -i s/-Werror//g CMakeLists.txt
}

build() {
	cd "$builddir"/build
	cmake "$builddir" \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=RelWithDebInfo \
		-DENABLE_WAYLAND=OFF

	# Parallel building breaks it
	make -j1
}

package() {
	cd "$builddir"/build
	DESTDIR="$pkgdir" make install

	install -m755 -D "$srcdir"/anbox-container-manager.initd \
		"$pkgdir"/etc/init.d/anbox-container-manager
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
	install -m644 -D "$srcdir"/99-anbox.rules \
		"$pkgdir"/lib/udev/rules.d/99-anbox.rules
	install -m644 -D "$srcdir"/$pkgname-launch.sh \
		"$pkgdir"/usr/bin/$pkgname-launch
	install -m644 -D "$srcdir"/$pkgname.desktop \
		"$pkgdir"/usr/share/applications/$pkgname.desktop
	install -m644 -D "$srcdir"/modules.conf \
		"$pkgdir"/etc/modules-load.d/$pkgname.conf
}

sha512sums="cea653225311a6b0c478bba091739888023a213b89d789acf47a4ee891f70e012b472836ecdb6301e467c48ae7bdcbbe648b36f0f03b6a69fa838f020a66cbd0  anbox-33b0654b34e897923c682b9bbfa6c1ca280064a2.tar.gz
59803d3468084b63c9a5e993fe0be1f9e8ee105e3a0724d406f065ae1c3be1ba2b4fe89bd33d4465739df407542f68871e787e2afc3d05a7055d5a6df9fa30cf  99-anbox.rules
829dd8e14196c6ddb3d2913e6924f98415287fb706cd5e4fcc122df471117f81a8f77b732276c4ebf1979db756b26d083be706b39f69581fa3a16c37a6299f86  anbox-container-manager.initd
6a3bc88142c5287ec54d481a4788eceb7772d9974af950b5286ce63a49d05d9d49fce5ba1d02b4b1c9893896fd4ba218fd4d39b8e640bdd61ad196b5d5c9a021  anbox.confd
8092bfb6a86da1a3fd26d3001665a37fbf354b65a5ffbd0d73795c0cb9bc69b6bc3e8c7caef13990af85e2e690c762e553af58f78c0f1e8533634f894ab2c30c  boost_io_context.patch
3351edbd50370f514e405f10584264b110cd3d5eff766185b23d4c7e885933f0378330df5222fbd4b5161ff81f292ea63b4940f4afb1c457a2511fe8b5110195  disable-tests.patch
e5a724a7eb684c898fd7fdb1b1d6630155a981f8e8c43e1171c6c0b9a0e8dec10d314262dd580e7aa99fbe6168df5fc234a8fb6b5b742c9690106a50ae77c283  musl-fixes.patch
93994207cd98792c747f80a807226c5fdf3e7cfc02490642c561330bcbf739ac7a65c1dd4634a1891d06d8624abb62bffc028fff7226fd1843a60ce630379893  anbox-launch.sh
de4d71d13c180db348fe9c839cd08e3764b9363f7404ea739f78d2c30f0a10ade437ec3518eec895a4cf3a34af70a46d55a2836ac8ca1247a237071e505317fa  anbox.desktop
916a53581844bef3e330e2ca2641dc4aa942b8e6336f64d01023c0734cce71c94c233447083ee2cce05b642b33cc9388ae9fcbf78b9d75a38a2236dc1b1c4dbe  modules.conf"
