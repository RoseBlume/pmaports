# Contributor: Jakub Panek <me@panekj.dev>
# Maintainer: Caleb Connolly <caleb@postmarketos.org>
# Co-Maintainer: jane400 <pmos@j4ne.de>

pkgname=systemd
pkgver=256_rc1
_pkgver='256-rc1'
pkgrel=0
pkgdesc="System and service manager"
url="https://github.com/systemd/systemd"
arch="all !ppc64le !armhf !s390x" # blocked by pmboostrap not supporting
license="MIT AND GPL-2.0-only AND LGPL-2.1-or-later"
options="pmb:strict !check" # few tests fail, need to debug. We use alpine dbus for building, systemd-dbus for runtime


makedepends="
	acl-dev
	audit-dev
	bash
	bash-completion
	clang
	cmake
	coreutils
	cryptsetup-dev
	elfutils
	glib-dev
	gperf
	kmod-dev
	libapparmor-dev
	libbpf-dev
	libbz2
	libcap-dev
	libfido2-dev
	libgcc
	libgcrypt-dev
	libintl
	libiptcdata-dev
	libmicrohttpd-dev
	libpwquality
	libqrencode-dev
	libseccomp-dev
	libselinux-dev
	libxkbcommon-dev
	linux-pam-dev
	llvm15
	lz4-dev
	meson
	musl-dev
	pcre2-dev
	perl
	pkgconf
	py3-jinja2
	py3-lxml
	python3-dev
	rsync
	tpm2-tss-mu
	tzdata
	util-linux-dev
	xz-dev
	zstd-dev
	gnu-efi-dev
	"

# We add these as explicit dependencies to ensure we get the systemd variants
# and not the Alpine ones.
depends="
	!openrc
	kbd
	kmod
"
if [ -z "$BOOTSTRAP" ] || [ "$BOOTSTRAP" -gt 2 ]; then
	makedepends="$makedepends
		dbus-dev
		polkit-dev
	"
else
	makedepends="$makedepends
		dbus-dev<999
		polkit-dev<999
	"
fi

# provides=openrc and openrc-settingsd to prevent those packages
# getting pulled in, as there are some conflicts (dbus)
provides="busctl eudev openrc-settingsd=$pkgver-r$pkgrel"
provider_priority=100

install="$pkgname.post-install"
subpackages="
	$pkgname-dbg
	$pkgname-dev
	$pkgname-doc
	$pkgname-x11

	$pkgname-udevd
	$pkgname-udevd-zsh-completion:udevd_zcomp:noarch
	$pkgname-udevd-bash-completion:udevd_bcomp:noarch

	$pkgname-timesyncd
	$pkgname-timesyncd-zsh-completion:timesyncd_zcomp:noarch
	$pkgname-timesyncd-bash-completion:timesyncd_bcomp:noarch

	$pkgname-networkd
	$pkgname-networkd-zsh-completion:networkd_zcomp:noarch
	$pkgname-networkd-bash-completion:networkd_bcomp:noarch

	$pkgname-resolved
	$pkgname-resolved-zsh-completion:resolved_zcomp:noarch
	$pkgname-resolved-bash-completion:resolved_bcomp:noarch

	$pkgname-logind
	$pkgname-logind-zsh-completion:logind_zcomp:noarch
	$pkgname-logind-bash-completion:logind_bcomp:noarch

	$pkgname-journald
	$pkgname-journald-zsh-completion:journald_zcomp:noarch
	$pkgname-journald-bash-completion:journald_bcomp:noarch

	$pkgname-libs

	$pkgname-bash-completion
	$pkgname-zsh-completion
	"

source="
	https://github.com/systemd/systemd/archive/refs/tags/v$_pkgver/systemd-$_pkgver.tar.gz
	0001-add-fallback-parse_printf_format-implementation.patch
	0002-errno-util-Make-STRERROR-portable-for-musl.patch
	0003-Handle-__cpu_mask-usage.patch
	0004-avoid-redefinition-of-prctl_mm_map-structure.patch
	0005-Use-uintmax_t-for-handling-rlim_t.patch
	0006-shared-Do-not-use-malloc_info-on-musl.patch
	0007-sd-event-Make-malloc_trim-conditional-on-glibc.patch
	0008-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
	0009-musl-fixes.patch
	0010-build-path-fix-SIGSEGV-on-RISC-V-and-MIPS.patch
	0011-build-path-musl-fix.patch
	0012-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
	0013-musl-missing-gshadow.patch
	wired.network
	"
builddir="$srcdir/systemd-$_pkgver"

export CFLAGS="$CFLAGS -D__UAPI_DEF_ETHHDR=0" # see src/basic/linux/if_ether.h

_bashcomp="usr/share/bash-completion/completions"
_zshcomp="usr/share/zsh/site-functions"

_default_bashcomp() {
	depends=""
	pkgdesc="Bash completions for $pkgname"
	install_if="$pkgname=$pkgver-r$pkgrel bash-completion"

	cd "$pkgdir" || return 0
	amove "$_bashcomp/$1"
}

_default_zshcomp() {
	depends=""
	pkgdesc="Zsh completions for $pkgname"
	install_if="$pkgname=$pkgver-r$pkgrel zsh"

	cd "$pkgdir" || return 0
	amove "$_zshcomp/$1"
}

build() {
	abuild-meson \
		-Dmode=release \
		\
		-Dkmod-path=/bin/kmod \
		-Dsulogin-path=/sbin/sulogin \
		\
		-Ddebug-shell=/bin/ash \
		-Dsplit-bin=false \
		-Dpolkit=enabled \
		-Dpam=enabled \
		-Dpamlibdir=/usr/lib/security \
		-Dpamconfdir=/etc/pam.d \
		\
		-Dutmp=false \
		-Dldconfig=false \
		-Dlocaled=false \
		-Duserdb=false \
		-Dhomed=disabled \
		-Dnss-myhostname=false \
		-Dnss-mymachines=disabled \
		-Dnss-resolve=disabled \
		-Dnss-systemd=false \
		-Dsysusers=false \
		-Dhtml=disabled \
		-Dtranslations=false \
		-Dselinux=disabled \
		\
		-Dsystem-alloc-uid-min=101 \
		-Dsystem-alloc-gid-min=101 \
		-Dsystem-uid-max=999 \
		-Dsystem-gid-max=999 \
		-Dwheel-group=true \
		-Dnobody-user=nobody \
		-Dnobody-group=nobody \
		\
		-Ddefault-kill-user-processes=true \
		-Dgshadow=false \
		-Ddefault-locale=en_US.UTF-8 \
		\
		-Ddefault-dns-over-tls=yes \
		-Ddns-over-tls=openssl \
		-Ddns-servers="9.9.9.10#dns10.quad9.net 149.112.112.10#dns10.quad9.net 2620:fe::10#dns10.quad9.net 2620:fe::fe:10#dns10.quad9.net" \
		-Dntp-servers="0.pool.ntp.org 1.pool.ntp.org 2.pool.ntp.org 4.pool.ntp.org" \
		\
		-Didn=false \
		-Dsysvinit-path="" \
		build .
	meson compile ${JOBS:+-j ${JOBS}} -C build
}

check() {
	meson test -C build
}

package() {
	# NOTE: as we can't parse .note.dlopen yet, we specify so:libkmod.so.2 here.
	# This wouldn't be needed for a container or similiar, but this doesn't apply to us.
	# Also this theoretically needs to be in the systemd-libs pacakage.
	#
	# FIXME: For some reason not stripping the binary didn't result in .note.dlopen to placed. Investigate!
	# https://github.com/systemd/systemd/blob/main/docs/ELF_DLOPEN_METADATA.md
	depends="$pkgname-udevd $pkgname-journald util-linux-login less so:libkmod.so.2"

	DESTDIR="$pkgdir" meson install --no-rebuild -C build

	# ship default policy to leave services disabled
	mkdir -p "$pkgdir"/usr/lib/systemd/system-preset
	echo 'disable *' > "$pkgdir"/usr/lib/systemd/system-preset/99-default.preset

}

udevd() {
	pkgdesc="systemd udev"

	# NOTE: should only be udev, but packages hardcode eudev
	provides="eudev udev eudev-libs"
	provider_priority=100

	amove usr/bin/udevadm
	amove etc/udev
	amove usr/lib/libudev*
	amove usr/lib/systemd/system/initrd-udevadm-cleanup-db.service
	amove usr/lib/systemd/system/sockets.target.wants/systemd-udev*
	amove usr/lib/systemd/system/sysinit.target.wants/systemd-udev*
	amove usr/lib/systemd/system/systemd-udev*
	amove usr/lib/systemd/systemd-udevd
	amove usr/lib/udev
}

udevd_bcomp() {
	_default_bashcomp udevadm
}

udevd_zcomp() {
	_default_zshcomp _udevadm
}

timesyncd() {
	pkgdesc="systemd Time Synchronization"

	amove etc/systemd/timesyncd.conf
	amove usr/bin/timedatectl
	amove usr/lib/systemd/ntp-units.d/80-systemd-timesync.list
	amove usr/lib/systemd/systemd-timesyncd
	amove usr/lib/systemd/system/systemd-timesyncd.service
	amove usr/share/dbus-1/system-services/org.freedesktop.timesync1.service
	amove usr/share/dbus-1/system.d/org.freedesktop.timesync1.conf
}

timesyncd_bcomp() {
	_default_bashcomp timedatectl
}

timesyncd_zcomp() {
	_default_zshcomp _timedatectl
}

networkd() {
	pkgdesc="systemd Network Configuration"

	amove usr/bin/networkctl
	amove etc/systemd/network
	amove etc/systemd/networkd.conf
	amove usr/share/polkit-1/rules.d/systemd-networkd.rules
	amove usr/lib/systemd/systemd-network-generator
	amove usr/lib/systemd/systemd-networkd
	amove usr/lib/systemd/systemd-networkd-wait-online
	amove usr/lib/systemd/network
	amove usr/lib/systemd/system/systemd-networkd.service
	amove usr/lib/systemd/system/systemd-networkd.socket
	amove usr/lib/systemd/system/systemd-networkd-wait-online.service
	amove usr/share/dbus-1/interfaces/org.freedesktop.network1.DHCPServer.xml
	amove usr/share/dbus-1/interfaces/org.freedesktop.network1.Link.xml
	amove usr/share/dbus-1/interfaces/org.freedesktop.network1.Manager.xml
	amove usr/share/dbus-1/interfaces/org.freedesktop.network1.Network.xml
	amove usr/share/dbus-1/system-services/org.freedesktop.network1.service
	amove usr/share/dbus-1/system.d/org.freedesktop.network1.conf
	amove usr/share/polkit-1/actions/org.freedesktop.network1.policy

	install -D -m0644 "$srcdir/wired.network" "$subpkgdir/usr/lib/systemd/network/80-wired.network"
}

networkd_bcomp() {
	_default_bashcomp networkctl
}

networkd_zcomp() {
	_default_zshcomp _networkctl
}

resolved() {
	pkgdesc="systemd Network Name Resolution"
	replaces="resolvconf"
	provides="resolvconf"

	amove etc/systemd/resolved.conf
	amove usr/lib/systemd/system/systemd-resolved.service
	amove usr/lib/systemd/systemd-resolved
	amove usr/bin/resolvconf
	amove usr/bin/resolvectl
	amove usr/bin/systemd-resolve
	amove usr/lib/tmpfiles.d/systemd-resolve.conf
	amove usr/share/dbus-1/interfaces/org.freedesktop.resolve1*
	amove usr/share/dbus-1/system-services/org.freedesktop.resolve1.service
	amove usr/share/dbus-1/system.d/org.freedesktop.resolve1.conf
	amove usr/share/polkit-1/actions/org.freedesktop.resolve1.policy
}

resolved_bcomp() {
	_default_bashcomp resolvectl
	_default_bashcomp systemd-resolve
}

resolved_zcomp() {
	_default_zshcomp _resolvectl
}

logind() {
	pkgdesc="systemd User Login Management"
	depends="dbus shadow"

	provides="elogind"
	provider_priority=100

	amove usr/lib/systemd/systemd-logind
	amove usr/lib/systemd/system/systemd-logind.service
}

logind_bcomp() {
	_default_bashcomp loginctl
}

logind_zcomp() {
	_default_zshcomp _loginctl
}

journald() {
	pkgdesc="systemd Journal"

	amove usr/bin/journalctl
	amove etc/systemd/journal-remote.conf
	amove etc/systemd/journald.conf
	amove usr/lib/systemd/system/sockets.target.wants/systemd-journal*
	amove usr/lib/systemd/system/systemd-journal*
	amove usr/lib/systemd/systemd-journal*
	amove usr/lib/tmpfiles.d/journal-nocow.conf
	amove var/log/journal
}

journald_bcomp() {
	_default_bashcomp journalctl
}

journald_zcomp() {
	_default_zshcomp _journalctl
}

x11() {
	pkgdesc="systemd x11"
	install_if="$pkgname=$pkgver-r$pkgrel xorg-server-common"

	amove usr/lib/tmpfiles.d/x11.conf
	amove etc/X11/xinit/xinitrc.d/50-systemd-user.sh
}

dev() {
	provides="eudev-dev udev-dev"
	provider_priority=100

	default_dev
}

sha512sums="
657d3e5743f7c951322907c94bcf08497f7e28efde8f08269173de4e53e57f883bae313a0bf2b5f88d762efa5816cb78f69c1b66c1e8ace7a4e4e005e7af5f14  systemd-256-rc1.tar.gz
9eb2351b4465dcf0a45b56a626fb048cfc4b99d69a1be7a22f0f4ff381ff47116c70717d4599fb7cc034f79bd1abc09e793e9af72b033311d6c1cb67987ad827  0001-add-fallback-parse_printf_format-implementation.patch
578d82e32df73314063afe19239123ecd5600c064c431dcfa073b9691609875ff22dbf06f9f08705cd6391ba93ddfa8e0b66735e6b225d5af1287aed8f545d40  0002-errno-util-Make-STRERROR-portable-for-musl.patch
36c869063d03d2435d2f1fc9d40448824f7458b7ac1b8923988593f8accfa602718fc832921c0350de529e62851cbc6bc3f1f698c62a0734b2fc975e55e771fa  0003-Handle-__cpu_mask-usage.patch
529584c8109eacbcbe70ec10bc42a4a0bd81ec2b8d1b795734f248496721232681d1c810ec4eab0362d1c281f65265feb821b0b8b46ff1ca8a4136cfa3d02247  0004-avoid-redefinition-of-prctl_mm_map-structure.patch
459065ff6cacb1d147e851bd21bccf031718d77760e84edf4ee2f8420ba2dca5255e3a9c21063909dd24e8a6e7dc5a29568e72a75a344380a660fbadc4b85eda  0005-Use-uintmax_t-for-handling-rlim_t.patch
b1710b1aee04e16a91301c73846596424d5cba8a525d18c216efa191212b1d011360a7f7a704569fae94778549b13cfe8d946752ca95450d0817d3881050e0ca  0006-shared-Do-not-use-malloc_info-on-musl.patch
15c6c62f371084d5b7fd83268aacf7d211b09e4d53d40f5ab6666dfa69ee9964a624a1ddb60b89504821761ebc9dc16616c462f2f38f4222c362e49382e5ec33  0007-sd-event-Make-malloc_trim-conditional-on-glibc.patch
77055f3ce188ed714f313874f8378519634841ce60d59795015ebced1dcf8748fafca203bf06bd3c1e4b3afd8b344361f0cff136a5dbbc0737916e490affe253  0008-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
66ab8ae674d0d51b0bc1b7dd1b25f7ee6213fd3a5c53f3b7ccdd489e6abed979ea255a913c7b8b06b05dd657e6c6b8980ed30de79fd34c979e882828d7642110  0009-musl-fixes.patch
a7f78760a37b591517ef3e362f2eee8abb7b89702f0cade7a62760ddbed32910c636440715e7aaa2f9796d68b2b94a70e6618e12dbfa46516b47d17c43e9828e  0010-build-path-fix-SIGSEGV-on-RISC-V-and-MIPS.patch
0e3273c450b890d7f6bd218f088afe9b1dc924203104f6c8364e3b560eaebbb85699cd9cb5fecec986add39cb2445a9f5c40aa6b8a023702dd6086e3d3d359d1  0011-build-path-musl-fix.patch
0aecbaae0076ca47208f5469471633931c76750a0cbb1310e5297501bf884e376d04d1e8f212f6a23c546300bf157606d31047df0fd20ce7ef9136edb0e0829b  0012-Do-not-disable-buffering-when-writing-to-oom_score_a.patch
da55b44263274056953eb4928e5e0c8eefcff08b31b3c79938e8819b94e934ec9729e1b0450703b2d7a8a60fb3561838520d95ba1fc6111d736ca8be4f217bac  0013-musl-missing-gshadow.patch
81c897fed8a3fbfb67ec591b2398a5d65e4af1b3ef379376c157c98d71f085b707f8ebc896d5571a94f99f8fc84fd6b43e3b879ca9b0d57fc6c4596034c7a777  wired.network
"
